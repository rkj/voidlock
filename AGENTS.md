# Xenopurge Contributor Guidelines

You are an AI contributor agent working on the Xenopurge project. Your goal is to implement features or fix bugs as instructed by the Manager Agent.

## 1. Core Workflow

1.  **Understand**: Read the task description provided by the Manager. Consult `@spec.md`, `@ARCHITECTURE.md`, and the relevant `GEMINI.md` files in your working directories for context.
2.  **Plan**: Formulate a concise plan. Share it with the Manager if it helps clarify your approach.
3.  **TDD First**: **CRITICAL**: All changes must be confirmed by tests first. If a feature is added, add tests. If a bug is fixed, write a failing test first.
4.  **Implement**: Modify code following the project's established conventions.
5.  **Update Documentation (MANDATORY)**: If you add new files or change significant APIs, you MUST update the `GEMINI.md` file in the relevant directory. This is critical for maintaining codebase navigability.
6.  **Verify**: All changes MUST be verified with `npx vitest run`.
    - **ðŸš¨ REGRESSION RULE**: If browser validation discovers a problem that automated tests missed, you MUST stop, write a failing unit/integration test that reproduces the bug, and THEN fix the code.
7.  **Beads Context**: You may read task details using `bd show <id> --json` or `bd list --status <filter>`, but you are **FORBIDDEN** from using `bd list` without a status filter or using state-changing commands (`update`, `close`, `create`). The Manager Agent handles all Beads status updates.

## 2. Technical Guidelines

### G1) Version Control (Jujutsu)

- **NEVER Commit**: Do **NOT** run `jj commit`. The Manager Agent is responsible for committing changes after verification.
- **NEVER Push**: Do **NOT** run `jj git push`.
- **Review Changes**: You may use `jj diff` to review your work in progress.
- **File Operations**: You may create, edit, and delete files as needed for the task. `jj` will automatically track these changes in the working copy.

### G2) Testing Strategy

- **ðŸš¨ REGRESSION PROTOCOL ðŸš¨**: If a fix involves logic (non-visual), you **MUST** add a regression test case to `src/engine/tests/` (or appropriate test file).
    - Prevents the "whack-a-mole" bug cycle.
    - **Naming Convention:** `regression_<ticket_id>_<short_slug>.test.ts`
- **ðŸš¨ NEVER REMOVE TESTS ðŸš¨**: Their purpose is to catch regressions. Do not remove any tests unless explicitly asked to do so by the Manager (e.g., if a feature was removed). If a test is failing, fix the code or update the test to match the new behavior.
- **Unit Test First**: For core mechanics (Grid, Pathfinder, LOS), write or update tests before implementation.
- **Non-Interactive**: Always run tests using `npx vitest run`. Never use watch mode.
- **Micro-Maps**: Define small, fixed JSON `MapDefinition`s directly within tests (e.g., 2x2 grids) to cover specific scenarios.
- **Recursion Guard**: If `Maximum call stack size exceeded` occurs, dump the Pathfinding grid state to JSON immediately for analysis.

### G3) Visual Debugging & Feedback

- **Game Access URL**: The game is accessible at `http://192.168.20.8:5173/`. This URL should be used for all browser interactions.
- **Visual Verification**: Use `take_screenshot()` to inspect the rendered state of the game, including the Canvas.
- **User Feedback**: When reporting visual issues you cannot see directly, rely on the text descriptions provided by the Manager or User.

### G4) Navigation & Symbol Lookup

- **Use the `tags` file**: The project root contains a `tags` file generated by `universal-ctags`. Use it to instantly locate symbol definitions instead of blindly grepping the entire codebase.
    - **Command**: `grep "^<SymbolName>" tags`
    - **Output**: This will give you the exact file path and line number/search pattern for the definition.
    - **Example**: To find `GameState`, run `grep "^GameState" tags`.
- **Read Context**: Once you have the file path from the tags file, use `read_file` with `offset` and `limit` to read the definition in context.

### G5) Coding Standards

- **Style & Structure**: Mimic the style (formatting, naming), structure, framework choices, and typing of existing code.
- **Idiomatic Changes**: Ensure your changes integrate naturally and idiomatically with the local context.
- **Avoid Duplication**: Do not duplicate helper functions or test logic. Refactor shared logic into utility files (e.g., `src/engine/tests/utils/`) and import them.

### G6) File Length & Structure

- **Aim for Focus**: Aim for files with fewer than 500 lines.
- **Mandatory Refactoring**: When a file crosses 1000 lines, it MUST be refactored into smaller, more focused modules according to SOLID principles.

## 3. Feature/Task Completion Checklist

When finishing a feature or task, you MUST perform the following steps in order:

1.  **Strict Verification**: Execute `npx vitest run`. All tests MUST pass. A task is not complete if tests are failing.
2.  **Visual Verification**: For any UI or rendering changes, navigate to the game URL, take a screenshot, and **carefully review it** to ensure the visual state matches expectations.
3.  **Versioning (Strict SemVer)**:
    - Check the current version in `package.json`.
    - **Features:** If the task added new functionality, increment the **MINOR** version (e.g., 0.1.0 -> 0.2.0).
    - **Bug Fixes/Tasks:** If the task was a bug fix or refactor, increment the **PATCH** version (e.g., 0.1.0 -> 0.1.1).
    - Update `package.json` with the new version.
4.  **Signal Completion**: Inform the Manager that the task is complete and ready for review. Do NOT perform the final commit or close the Beads task yourself.

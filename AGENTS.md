# Voidlock Contributor Guidelines

You are an AI contributor agent working on the Voidlock project. Your goal is to implement features or fix bugs as instructed by the Manager Agent.

## 1. Core Workflow

1. **DIRECT INTERVENTION (User Questions):** If the user asks a question, YOU MUST STOP ALL WORK. Answer the question immediately. Do not queue further tool calls or tasks. Do not say "I will now...". Just answer.
1. **TOOL FAILURE PROTOCOL:** If a tool call fails due to **permissions** (e.g., "denied by policy") or **installation errors** (e.g., missing dependency that you cannot install), **STOP IMMEDIATELY**. Do not hallucinate a workaround. Report the blocker to the user and ask for instructions.
1. **VISUAL VERIFICATION:** When a task involves UI layout, CSS, or scrolling:
   - Try automated E2E tests.
   - If E2E fails or is unavailable, **YOU MUST** use `chrome-devtools-mcp` tools (`navigate_page`, `take_screenshot`) to visually verify the change.
   - **NEVER** rely solely on JSDOM for visual/layout verification. It does not render pixels.
1. **ADR INTEGRITY:** Architectural Decision Records (ADRs) are **IMMUTABLE**. You are strictly forbidden from editing an established ADR. If a task requires changing an existing design, you must first create a **NEW** ADR that provides historical context and describes the proposed changes.
1. **Understand**: Read the task description...
1. **Plan**: Formulate a concise plan. Share it with the Manager if it helps clarify your approach.
1. **TDD First**: **CRITICAL**: All changes must be confirmed by tests first. If a feature is added, add tests. If a bug is fixed, write a failing test first.
1. **Implement**: Modify code following the project's established conventions.
1. **Update Documentation (MANDATORY)**: If you add new files or change significant APIs, you MUST update the `GEMINI.md` file in the relevant directory. This is critical for maintaining codebase navigability.
1. **Verify**: All changes MUST be verified with `npx vitest run`.
   - **RESTRICT TEST OUTPUT**: You must never read the full output of a passing test suite.
   - **Concise Reporters**: Use `npx vitest run --reporter=basic` or pipe to `grep FAIL` to see only relevant information.
   - **Output Truncation**: If output exceeds 50 lines, truncate it to show only the final summary and specific errors.
   - **Targeted Testing**: Use `npx vitest run <PATH_TO_TEST>`...
   - **ðŸš¨ REGRESSION RULE**: If browser validation discovers a problem that automated tests missed, you MUST stop, write a failing unit/integration test that reproduces the bug, and THEN fix the code.
1. **Beads Context**: You may read task details using `bd show <id> --json` and you are **FORBIDDEN** from using `bd list` using state-changing commands (`update`, `close`, `create`). The Manager Agent handles all Beads status updates.

## 2. Technical Guidelines

### G1) Version Control (Jujutsu)

- **NEVER Commit**: Do **NOT** run `jj commit`. The Manager Agent is responsible for committing changes after verification.
- **NEVER Push**: Do **NOT** run `jj git push`.
- **Review Changes**: You may use `jj diff --git` to review your work in progress.
- **File Operations**: You may create, edit, and delete files as needed for the task. `jj` will automatically track these changes in the working copy.

### G2) Testing Strategy

- **ðŸš¨ REGRESSION PROTOCOL ðŸš¨**: If a fix involves logic (non-visual), you **MUST** add a regression test case to `src/engine/tests/` (or appropriate test file).
  - Prevents the "whack-a-mole" bug cycle.
  - **Naming Convention:** `regression_<ticket_id>_<short_slug>.test.ts`
- **ðŸš¨ NEVER REMOVE TESTS ðŸš¨**: Their purpose is to catch regressions. Do not remove any tests unless explicitly asked to do so by the Manager (e.g., if a feature was removed). If a test is failing, fix the code or update the test to match the new behavior.
- **Unit Test First**: For core mechanics (Grid, Pathfinder, LOS), write or update tests before implementation.
- **Non-Interactive**: Always run tests using `npx vitest run`. Never use watch mode.
- **Micro-Maps**: Define small, fixed JSON `MapDefinition`s directly within tests (e.g., 2x2 grids) to cover specific scenarios.
- **Recursion Guard**: If `Maximum call stack size exceeded` occurs, dump the Pathfinding grid state to JSON immediately for analysis.

### G3) Visual Debugging & Feedback

- **Game Access URL**: The game is accessible at `http://192.168.20.8:5173/`. This URL should be used for all browser interactions.
- **Visual Verification**: Use `take_screenshot()` to inspect the rendered state of the game, including the Canvas.
- **User Feedback**: When reporting visual issues you cannot see directly, rely on the text descriptions provided by the Manager or User.

### G4) Navigation & Symbol Lookup

- **Use the `tags` file**: The project root contains a `tags` file generated by `universal-ctags`. Use it to instantly locate symbol definitions instead of blindly grepping the entire codebase.
  - **Command**: `grep "^<SymbolName>" tags`
  - **Output**: This will give you the exact file path and line number/search pattern for the definition.
  - **Example**: To find `GameState`, run `grep "^GameState" tags`.
- **Read Context**: Once you have the file path from the tags file, use `read_file` with `offset` and `limit` to read the definition in context.

### G5) Coding Standards

- **Style & Structure**: Mimic the style (formatting, naming), structure, framework choices, and typing of existing code.
- **Idiomatic Changes**: Ensure your changes integrate naturally and idiomatically with the local context.
- **Avoid Duplication**: Do not duplicate helper functions or test logic. Refactor shared logic into utility files (e.g., `src/engine/tests/utils/`) and import them.

### G6) File Length & Structure

- **Aim for Focus**: Aim for files with fewer than 500 lines.
- **Mandatory Refactoring**: When a file crosses 1000 lines, it MUST be refactored into smaller, more focused modules according to SOLID principles.

### G7) Documentation Integrity (Specs)

- **Read-Only**: The `spec/` directory is **READ-ONLY** for coding agents. You must NEVER modify these files.
- **Authority**: These files are the Single Source of Truth. If you find a contradiction between the code and the spec, assume the spec is correct (unless explicitly told otherwise by the Manager).
- **Updates**: Only the Manager Agent (PM) is authorized to modify specs, in coordination with the human user.

### G8) Engineering Standards (Strict Enforcement)

- **Production Ready**: All code must be robust, error-handled, and free of debug logs or temporary hacks.
- **SOLID Principles**: Adhere strictly to SOLID principles.
  - **S**: Single Responsibility Principle.
  - **O**: Open/Closed Principle.
  - **L**: Liskov Substitution Principle.
  - **I**: Interface Segregation Principle.
  - **D**: Dependency Inversion Principle.
- **TDD (Test-Driven Development)**: You must write the test _before_ the implementation.
  - **Red**: Write a failing test that reproduces the bug or defines the new feature.
  - **Green**: Write the minimal code to make the test pass.
  - **Refactor**: Improve the code while keeping the test passing.
- **Spec-Driven**: Your implementation must exactly match the `docs/spec/` requirements. Do not invent features.

## 3. Feature/Task Completion Checklist

When finishing a feature or task, you MUST perform the following steps in order:

1. **Strict Verification**: Execute `npx vitest run`. All tests MUST pass. A task is not complete if tests are failing.
   - Use `npx vitest run <PATH_TO_TEST>` for faster feedback on specific files.
1. **Visual Verification**: For any UI or rendering changes, navigate to the game URL, take a screenshot, and **carefully review it** to ensure the visual state matches expectations.
1. **Versioning (Strict SemVer)**:
   - Check the current version in `package.json`.
   - **Features:** If the task added new functionality, increment the **MINOR** version (e.g., 0.1.0 -> 0.2.0).
   - **Bug Fixes/Tasks:** If the task was a bug fix or refactor, increment the **PATCH** version (e.g., 0.1.0 -> 0.1.1).
   - Update `package.json` with the new version.
1. **Signal Completion**: Inform the Manager that the task is complete and ready for review. Do NOT perform the final commit or close the Beads task yourself.
1. **NEVER Close as Failed**: Beads does not support a "failed" state. If a task cannot be completed or is blocked, leave it OPEN. Add a comment explaining the issue and return control to the Manager. Closing a task means it is fixed/done.
